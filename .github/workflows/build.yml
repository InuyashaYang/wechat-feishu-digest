name: Build & Release Windows EXE

on:
  push:
    branches: [master]
  workflow_dispatch:        # 支持手动触发

permissions:
  contents: write           # 允许创建/更新 Release

env:
  PYTHONUTF8: "1"           # 所有 Python 步骤强制 UTF-8 输出
  PYTHONIOENCODING: "utf-8"

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest

    steps:
      # ── 1. 检出代码 ────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. 环境准备 ────────────────────────────────────────────────────────
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: build/requirements-build.txt

      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      # ── 3. 安装依赖 ────────────────────────────────────────────────────────
      - name: Install Python deps
        run: pip install -r build/requirements-build.txt

      - name: Install Node deps (cheerio)
        working-directory: wechat_search
        run: npm install cheerio --no-audit --prefer-offline

      # ── 4. 生成图标 ────────────────────────────────────────────────────────
      - name: Generate icon
        run: python build/make_icon.py

      # ── 5. 打包 EXE ────────────────────────────────────────────────────────
      - name: Build EXE
        run: python -m PyInstaller build/wechat-digest.spec --noconfirm --clean

      - name: Verify EXE exists
        run: |
          $f = "dist\wechat-digest.exe"
          if (-not (Test-Path $f)) { throw "EXE not found!" }
          $mb = [math]::Round((Get-Item $f).Length/1MB,1)
          Write-Host "wechat-digest.exe  $mb MB"
        shell: pwsh

      # ── 6. 打包发布物 ──────────────────────────────────────────────────────
      - name: Prepare release assets
        shell: pwsh
        run: |
          Copy-Item .env.example dist\.env.example
          $date = Get-Date -Format "yyyy-MM-dd HH:mm UTC"
          $sha  = "${{ github.sha }}".Substring(0,7)
          Set-Content dist\RELEASE_INFO.txt "Build: $date`nCommit: $sha`nBranch: ${{ github.ref_name }}"

      # ── 7. 上传 Artifact (方便直接下载，不依赖 Release) ──────────────────
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wechat-digest-windows
          path: |
            dist/wechat-digest.exe
            dist/.env.example
          retention-days: 30

      # ── 8. 更新 latest Release ─────────────────────────────────────────────
      - name: Update latest release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $sha  = "${{ github.sha }}".Substring(0,7)
          $date = Get-Date -Format "yyyy-MM-dd"
          $body = @"
          ## AI 公众号周报 - 最新构建

          > 自动构建于 $date，commit ``$sha``

          ### 下载使用
          1. 点击下方 **wechat-digest.exe** 下载（约 10 MB）
          2. 双击运行，浏览器自动打开 http://localhost:8765
          3. 在界面里填入 **OpenRouter API Key**，配置账号，点「一键运行」

          ### 首次配置
          - 下载 ``.env.example``，复制为 ``.env``，填写 API Key
          - 或直接在 Web UI 里填写，点保存即可

          ### 功能
          - 爬取机器之心、新智元、量子位、36氪、钛媒体等多个公众号
          - AI 聚合摘要（技术动态 + 投融资动态双板块）
          - 可视化进度面板（步骤条 + 账号卡片 + 进度条）
          - 输出到飞书文档 或 本地 Markdown/JSON
          "@

          # 删除旧的 latest release 和 tag（忽略报错）
          gh release delete latest --yes 2>$null
          git push origin :refs/tags/latest 2>$null

          # 创建新的 latest release
          gh release create latest `
            "dist/wechat-digest.exe" `
            "dist/.env.example" `
            --title "Latest Build ($date)" `
            --notes $body `
            --prerelease
