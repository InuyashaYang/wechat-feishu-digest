<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI å…¬ä¼—å·å‘¨æŠ¥</title>
<style>
:root{--bg:#0f1117;--bg2:#161b22;--bg3:#21262d;--border:#30363d;--text:#e6edf3;--muted:#8b949e;--accent:#58a6ff;--green:#3fb950;--yellow:#d29922;--red:#f85149;--purple:#bc8cff;--r:8px;--font:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;padding:24px 16px}
.container{max-width:880px;margin:0 auto}
/* Header */
.hdr{margin-bottom:24px}
.hdr h1{font-size:22px;font-weight:600;display:flex;align-items:center;gap:10px}
.hdr h1 .badge{font-size:11px;padding:2px 8px;border-radius:12px;background:var(--bg3);color:var(--muted);font-weight:400;border:1px solid var(--border)}
.hdr p{color:var(--muted);margin-top:6px;font-size:13px}
/* Card */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:16px}
.card-title{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:16px}
/* Form */
.field{margin-bottom:14px}.field:last-child{margin-bottom:0}
label{display:block;font-size:13px;color:var(--text);margin-bottom:6px;font-weight:500}
label .hint{font-weight:400;color:var(--muted);margin-left:6px;font-size:12px}
input[type=text],input[type=password],input[type=number],select{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;padding:8px 12px;font-family:var(--font);outline:none;transition:border-color .15s}
input:focus,select:focus{border-color:var(--accent)}
input[type=number]{width:100px}
.mono{font-family:"SFMono-Regular",Consolas,monospace;font-size:12px}
.grp{border:1px solid var(--border);border-radius:6px;padding:14px;margin-bottom:12px}
.grp:last-child{margin-bottom:0}
.grp-lbl{font-size:12px;color:var(--accent);font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.grp-lbl .dot{width:7px;height:7px;border-radius:50%;background:currentColor}
.row{display:flex;gap:12px}.row .field{flex:1}.row .field.n{flex:0 0 120px}
.btn{display:inline-flex;align-items:center;gap:7px;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--bg3);color:var(--text);transition:all .15s;font-family:var(--font)}
.btn:hover{background:#2d333b;border-color:#8b949e}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.p{background:var(--accent);border-color:var(--accent);color:#0d1117;font-weight:600}.btn.p:hover{background:#79c0ff}
.btn-grp{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.iw{position:relative}.iw input{padding-right:36px}
.eyebtn{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:15px;padding:0}
.run-opts{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:14px}
.run-opts label{margin:0;display:flex;align-items:center;gap:6px;cursor:pointer}
.run-opts input[type=checkbox]{width:auto;accent-color:var(--accent)}
.run-opts select{width:auto}

/* ===== PROGRESS ===== */
#progress{display:none;margin-top:18px;border-top:1px solid var(--border);padding-top:16px}
#progress.on{display:block}
/* Steps */
.steps{display:flex;align-items:flex-start;margin-bottom:16px}
.step{display:flex;align-items:flex-start;gap:8px;flex:1}
.sdot{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--muted);background:var(--bg3);flex-shrink:0;transition:all .3s}
.sdot.active{border-color:var(--accent);color:var(--accent);background:#1f2d3d}
.sdot.done{border-color:var(--green);background:#122320;color:var(--green)}
.slbl{font-size:12px;color:var(--muted)}.slbl.active{color:var(--text);font-weight:600}.slbl.done{color:var(--green)}
.ssub{font-size:10px;color:var(--muted);margin-top:1px}.ssub.active{color:var(--accent)}
.sline{flex:1;height:2px;background:var(--border);margin:13px 6px 0;transition:background .4s}.sline.done{background:var(--green)}
/* Progress bar */
.pbar{margin-bottom:14px}
.pbar-top{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:5px}
.pbar-track{height:8px;background:var(--bg3);border-radius:4px;overflow:hidden}
.pbar-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:4px;transition:width .6s cubic-bezier(.4,0,.2,1);position:relative}
.pbar-fill.shimmer::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);animation:shimmer 1.4s infinite}
@keyframes shimmer{0%{transform:translateX(-200%)}100%{transform:translateX(200%)}}
/* Account grid */
.ag{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:14px}
.ac{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 8px;text-align:center;transition:border-color .25s,box-shadow .25s}
.ac.running{border-color:var(--accent);box-shadow:0 0 8px rgba(88,166,255,.15)}
.ac.done{border-color:var(--green)}
.ac-name{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--muted);margin-bottom:3px}
.ac.running .ac-name,.ac.done .ac-name{color:var(--text)}
.ac-num{font-size:22px;font-weight:700;color:var(--border);line-height:1.2}
.ac.done .ac-num{color:var(--text)}
.ac-unit{font-size:10px;color:var(--muted);margin-bottom:4px}
.abadge{display:inline-block;font-size:10px;padding:1px 7px;border-radius:10px}
.ab-wait{background:var(--bg);color:var(--muted)}
.ab-run{background:#1f2d3d;color:var(--accent);animation:pulse .9s infinite}
.ab-ok{background:#122320;color:var(--green)}
.ab-zero{background:#2d1117;color:var(--red)}
@keyframes pulse{50%{opacity:.4}}
/* Summary */
.sumrow{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.si{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 14px;flex:1;min-width:90px;text-align:center}
.si-val{font-size:24px;font-weight:700;line-height:1.1}
.si-lbl{font-size:11px;color:var(--muted);margin-top:2px}
/* Log */
.ltoggle{font-size:12px;color:var(--muted);cursor:pointer;user-select:none;display:flex;align-items:center;gap:5px;padding:4px 0}
.ltoggle:hover{color:var(--text)}
.larr{transition:transform .2s;display:inline-block}.larr.open{transform:rotate(90deg)}
#logpanel{background:var(--bg);border:1px solid var(--border);border-radius:var(--r);font-family:"SFMono-Regular",Consolas,monospace;font-size:11.5px;line-height:1.6;padding:12px 14px;height:200px;overflow-y:auto;color:#c9d1d9;white-space:pre-wrap;word-break:break-all;margin-top:6px;display:none}
.lok{color:var(--green)}.lwarn{color:var(--yellow)}.lgrp{color:var(--purple);font-weight:bold}.ldone{color:var(--green);font-weight:bold}.lhead{color:var(--accent)}
#reslink{margin-top:10px;font-size:13px;display:none}
#reslink a{color:var(--accent);text-decoration:none;font-weight:500}
/* Toast */
#toast{position:fixed;bottom:24px;right:24px;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:500;opacity:0;transform:translateY(6px);transition:all .2s;pointer-events:none;z-index:999}
#toast.show{opacity:1;transform:translateY(0)}
#toast.ok{background:#122320;color:var(--green);border:1px solid var(--green)}
#toast.err{background:#2d1117;color:var(--red);border:1px solid var(--red)}
</style>
</head>
<body>
<div class="container">

<div class="hdr">
  <h1>ğŸ— AI å…¬ä¼—å·å‘¨æŠ¥ <span class="badge">wechat-feishu-digest</span></h1>
  <p>é…ç½®å…³é”®è¯ Â· è®¾ç½® API Key Â· ä¸€é”®è¿è¡Œ Â· è¾“å‡ºåˆ°é£ä¹¦æˆ–æœ¬åœ°</p>
</div>

<!-- è´¦å·é…ç½® -->
<div class="card">
  <div class="card-title">ğŸ“° è´¦å· &amp; å…³é”®è¯</div>
  <div class="grp">
    <div class="grp-lbl"><span class="dot"></span> ç§‘æŠ€åª’ä½“</div>
    <div class="field"><label>è´¦å·åˆ—è¡¨ <span class="hint">é€—å·åˆ†éš”</span></label><input id="accounts" type="text" class="mono" placeholder="æœºå™¨ä¹‹å¿ƒ,æ–°æ™ºå…ƒ,é‡å­ä½"></div>
    <div class="field"><label>æœç´¢è¯æ¨¡æ¿ <span class="hint">{account} {year} {month} è‡ªåŠ¨æ›¿æ¢</span></label><input id="search_query_template" type="text" class="mono" placeholder="{account} AI å¤§æ¨¡å‹ {year}å¹´{month}æœˆ"></div>
  </div>
  <div class="grp">
    <div class="grp-lbl" style="color:var(--yellow)"><span class="dot"></span> æŠ•èµ„èµ„è®¯</div>
    <div class="field"><label>è´¦å·åˆ—è¡¨</label><input id="invest_accounts" type="text" class="mono" placeholder="36æ°ª,é’›åª’ä½“,æ™šç‚¹,ç¡…æ˜Ÿäºº"></div>
    <div class="field"><label>æœç´¢è¯æ¨¡æ¿</label><input id="invest_query_template" type="text" class="mono" placeholder="{account} AI èèµ„ å¤§æ¨¡å‹ {year}å¹´{month}æœˆ"></div>
  </div>
  <div class="grp">
    <div class="grp-lbl" style="color:var(--purple)"><span class="dot"></span> è‡ªå®šä¹‰ï¼ˆå¯é€‰ï¼‰</div>
    <div class="field"><label>è´¦å·åˆ—è¡¨ <span class="hint">ç•™ç©ºåˆ™è·³è¿‡</span></label><input id="extra_accounts" type="text" class="mono"></div>
    <div class="field"><label>æœç´¢è¯æ¨¡æ¿</label><input id="extra_query_template" type="text" class="mono"></div>
  </div>
</div>

<!-- API & è¾“å‡º -->
<div class="card">
  <div class="card-title">âš™ï¸ API &amp; è¾“å‡ºé…ç½®</div>
  <div class="row">
    <div class="field">
      <label>ğŸ¤– OpenRouter API Key</label>
      <div class="iw"><input id="openrouter_api_key" type="password" class="mono" placeholder="sk-or-v1-..."><button class="eyebtn" onclick="toggleEye('openrouter_api_key',this)">ğŸ‘</button></div>
    </div>
    <div class="field" style="flex:0 0 280px">
      <label>æ¨¡å‹ <span class="hint">å…è´¹é¢åº¦æ¨è</span></label>
      <select id="openrouter_model">
        <option value="stepfun/step-3.5-flash:free">stepfun/step-3.5-flash:free â­</option>
        <option value="google/gemini-2.0-flash-lite:free">gemini-2.0-flash-lite:free</option>
        <option value="google/gemini-2.5-flash:free">gemini-2.5-flash:free</option>
        <option value="qwen/qwen3.5-flash-02-23">qwen/qwen3.5-flash-02-23</option>
        <option value="openai/gpt-4o-mini">openai/gpt-4o-mini</option>
        <option value="custom">è‡ªå®šä¹‰...</option>
      </select>
      <input id="openrouter_model_custom" type="text" class="mono" style="margin-top:6px;display:none" placeholder="è¾“å…¥æ¨¡å‹ ID">
    </div>
  </div>
  <div class="row" style="margin-top:14px">
    <div class="field"><label>ğŸ“ æœ¬åœ°è¾“å‡ºç›®å½•</label><input id="local_output_dir" type="text" class="mono" placeholder="./output"></div>
    <div class="field n"><label>çˆ¬å–å¤©æ•°</label><input id="search_days" type="number" min="1" max="30" value="7"></div>
    <div class="field n"><label>æ¯ç»„æ¡æ•°</label><input id="search_num" type="number" min="5" max="50" value="30"></div>
  </div>
  <details style="margin-top:14px">
    <summary style="font-size:13px;color:var(--muted);cursor:pointer;user-select:none">ğŸª¶ é£ä¹¦é…ç½®ï¼ˆé€‰å¡«ï¼‰</summary>
    <div style="margin-top:12px">
      <div class="row">
        <div class="field"><label>App ID</label><input id="feishu_app_id" type="text" class="mono" placeholder="cli_xxx"></div>
        <div class="field"><label>App Secret</label><div class="iw"><input id="feishu_app_secret" type="password" class="mono"><button class="eyebtn" onclick="toggleEye('feishu_app_secret',this)">ğŸ‘</button></div></div>
      </div>
      <div class="field" style="margin-top:10px"><label>å…±äº«ç»™ï¼ˆOpen IDï¼Œå¯é€‰ï¼‰</label><input id="feishu_share_openid" type="text" class="mono" placeholder="ou_xxx"></div>
    </div>
  </details>
</div>

<!-- è¿è¡Œé¢æ¿ -->
<div class="card">
  <div class="card-title">â–¶ è¿è¡Œ</div>
  <div class="run-opts">
    <span>è¾“å‡ºåˆ°ï¼š</span>
    <select id="run_output" style="width:auto">
      <option value="auto">è‡ªåŠ¨ï¼ˆæ ¹æ®é…ç½®ï¼‰</option>
      <option value="local">ä»…æœ¬åœ°</option>
      <option value="feishu">ä»…é£ä¹¦</option>
      <option value="both">é£ä¹¦ + æœ¬åœ°</option>
    </select>
    <span style="color:var(--border)">|</span>
    <label><input type="checkbox" id="run_no_ai"> è·³è¿‡ AI æ‘˜è¦</label>
    <label><input type="checkbox" id="run_dry_run"> é¢„è§ˆæ¨¡å¼</label>
  </div>
  <div class="btn-grp">
    <button class="btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
    <button class="btn p" id="run-btn" onclick="runCrawl()">â–¶ ä¸€é”®è¿è¡Œ</button>
  </div>

  <!-- ===== è¿›åº¦é¢æ¿ ===== -->
  <div id="progress">

    <!-- Step bar -->
    <div class="steps">
      <div class="step">
        <div class="sdot" id="sd0">1</div>
        <div><div class="slbl" id="sl0">çˆ¬å–æ–‡ç« </div><div class="ssub" id="ss0"></div></div>
      </div>
      <div class="sline" id="sln0"></div>
      <div class="step">
        <div class="sdot" id="sd1">2</div>
        <div><div class="slbl" id="sl1">AI æ‘˜è¦</div><div class="ssub" id="ss1"></div></div>
      </div>
      <div class="sline" id="sln1"></div>
      <div class="step">
        <div class="sdot" id="sd2">3</div>
        <div><div class="slbl" id="sl2">å†™å‡ºç»“æœ</div><div class="ssub" id="ss2"></div></div>
      </div>
    </div>

    <!-- Progress bar -->
    <div class="pbar">
      <div class="pbar-top"><span id="pbar-txt">å‡†å¤‡ä¸­...</span><span id="pbar-pct">0%</span></div>
      <div class="pbar-track"><div class="pbar-fill shimmer" id="pbar-fill"></div></div>
    </div>

    <!-- Account cards -->
    <div class="ag" id="ag"></div>

    <!-- Summary -->
    <div class="sumrow" id="sumrow" style="display:none">
      <div class="si"><div class="si-val" id="sv-tot" style="color:var(--accent)">0</div><div class="si-lbl">æ€»æ–‡ç« æ•°</div></div>
      <div class="si"><div class="si-val" id="sv-acc" style="color:var(--purple)">0</div><div class="si-lbl">å·²çˆ¬è´¦å·</div></div>
      <div class="si" id="si-fs" style="display:none"><div class="si-val" style="color:var(--green)">âœ“</div><div class="si-lbl">é£ä¹¦å·²å†™</div></div>
      <div class="si" id="si-lc" style="display:none"><div class="si-val" style="color:var(--green)">âœ“</div><div class="si-lbl">æœ¬åœ°å·²å†™</div></div>
    </div>

    <!-- Log collapsible -->
    <div class="ltoggle" onclick="toggleLog()"><span class="larr" id="larr">â–¶</span> è¯¦ç»†æ—¥å¿—</div>
    <div id="logpanel"></div>
  </div>

  <div id="reslink"></div>
</div>

</div><!-- container -->
<div id="toast"></div>

<script>
const API = '';

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let acctList = [], acctMap = {}, doneCnt = 0, totalCnt = 0, curAcct = null;
let logOpen = false;

function eid(n){ return 'ac_' + n.replace(/[^a-zA-Z0-9]/g,'_'); }

// â”€â”€â”€ Build account grid from config values â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildGrid() {
  const all = [
    ...(document.getElementById('accounts').value.split(',').map(s=>s.trim()).filter(Boolean)),
    ...(document.getElementById('invest_accounts').value.split(',').map(s=>s.trim()).filter(Boolean)),
    ...(document.getElementById('extra_accounts').value.split(',').map(s=>s.trim()).filter(Boolean)),
  ];
  acctList = all; totalCnt = all.length; doneCnt = 0; acctMap = {};
  const grid = document.getElementById('ag'); grid.innerHTML = '';
  all.forEach(name => {
    acctMap[name] = { status:'pending', recent:0, total:0 };
    const d = document.createElement('div');
    d.className = 'ac'; d.id = eid(name);
    d.innerHTML = `<div class="ac-name" title="${name}">${name}</div>
      <div class="ac-num" id="${eid(name)}_n">-</div>
      <div class="ac-unit">ç¯‡</div>
      <div><span class="abadge ab-wait" id="${eid(name)}_b">ç­‰å¾…</span></div>`;
    grid.appendChild(d);
  });
}

function acctRunning(name) {
  if (!acctMap[name]) return;
  acctMap[name].status = 'running';
  const card = document.getElementById(eid(name)); if (!card) return;
  card.className = 'ac running';
  setB(name, 'ab-run', 'Â·Â·Â·');
}

function acctDone(name, recent, total) {
  if (!acctMap[name]) return;
  acctMap[name] = { status:'done', recent, total };
  const card = document.getElementById(eid(name)); if (!card) return;
  card.className = 'ac done';
  document.getElementById(eid(name)+'_n').textContent = recent;
  if (recent === 0) setB(name,'ab-zero','0ç¯‡');
  else setB(name,'ab-ok','âœ“ '+total+'æ¡');
  doneCnt++;
  const pct = Math.round(doneCnt/totalCnt*65);
  setProgress(pct, 'çˆ¬å–ä¸­â€¦ ' + doneCnt + '/' + totalCnt);
  setStepSub(0, doneCnt+'/'+totalCnt);
}

function setB(name, cls, txt) {
  const b = document.getElementById(eid(name)+'_b'); if (!b) return;
  b.className = 'abadge ' + cls; b.textContent = txt;
}

// â”€â”€â”€ Steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStep(n) {
  for (let i=0;i<3;i++){
    const dot=document.getElementById('sd'+i), lbl=document.getElementById('sl'+i);
    if (i<n){ dot.className='sdot done'; dot.textContent='âœ“'; lbl.className='slbl done'; }
    else if(i===n){ dot.className='sdot active'; dot.textContent=''+(n+1); lbl.className='slbl active'; }
    else { dot.className='sdot'; dot.textContent=''+(i+1); lbl.className='slbl'; }
    if (i<2) document.getElementById('sln'+i).className='sline'+(i<n?' done':'');
  }
}
function setStepSub(i, txt) {
  const el = document.getElementById('ss'+i); if (el) el.textContent = txt;
}

// â”€â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setProgress(pct, txt) {
  document.getElementById('pbar-fill').style.width = pct+'%';
  document.getElementById('pbar-pct').textContent = pct+'%';
  if (txt) document.getElementById('pbar-txt').textContent = txt;
}

// â”€â”€â”€ Parse log lines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseLine(line) {
  // è´¦å·å¼€å§‹: "  [æœºå™¨ä¹‹å¿ƒ] '...' ..."
  const mS = line.match(/\[(.+?)\]\s+'.*?'\s+\.\.\./);
  if (mS) { curAcct = mS[1].trim(); acctRunning(curAcct); return; }

  // è´¦å·å®Œæˆ: "å…± 30 æ¡ â†’ è¿‘7å¤© 22 æ¡"
  const mD = line.match(/å…±\s*(\d+)\s*æ¡\s*â†’\s*è¿‘\d+å¤©\s*(\d+)\s*æ¡/);
  if (mD && curAcct) { acctDone(curAcct, parseInt(mD[2]), parseInt(mD[1])); curAcct = null; return; }

  // Step 2: AIæ‘˜è¦
  if (line.includes('AI èšåˆæ‘˜è¦ä¸­')) {
    setStep(1); setProgress(70, 'AI èšåˆæ‘˜è¦ä¸­...');
    setStepSub(1, 'ç”Ÿæˆä¸­...');
    return;
  }
  if (line.includes('æ‘˜è¦ä¸­... âœ“') || line.match(/æ‘˜è¦.*âœ“/)) {
    setStepSub(1, 'å®Œæˆ âœ“');
  }

  // Step 3: å†™å‡º
  if (line.includes('å†™å…¥é£ä¹¦') || line.includes('å†™å…¥æœ¬åœ°') || line.includes('è¾“å‡ºç›®æ ‡')) {
    setStep(2); setProgress(85, 'å†™å‡ºç»“æœ...');
    return;
  }

  // é£ä¹¦å®Œæˆ
  if (line.includes('é£ä¹¦æ–‡æ¡£:') || line.includes('feishu.cn')) {
    setProgress(92, 'é£ä¹¦å†™å…¥å®Œæˆ');
    document.getElementById('si-fs').style.display = '';
    const m = line.match(/https:\/\/feishu\.cn\/docx\/\S+/);
    if (m) {
      const rl = document.getElementById('reslink');
      rl.style.display = 'block';
      rl.innerHTML = 'ğŸ“„ é£ä¹¦æ–‡æ¡£ï¼š<a href="'+m[0]+'" target="_blank">'+m[0]+'</a>';
    }
  }

  // æœ¬åœ°å®Œæˆ
  if (line.match(/Markdown:|output\//)) {
    document.getElementById('si-lc').style.display = '';
  }

  // å…¨éƒ¨å®Œæˆ: "åˆè®¡: 91 ç¯‡"
  const mT = line.match(/åˆè®¡[ï¼š:]\s*(\d+)\s*ç¯‡/);
  if (mT) {
    const tot = parseInt(mT[1]);
    setStep(3); // all done
    setProgress(100, 'å…¨éƒ¨å®Œæˆï¼å…± '+tot+' ç¯‡');
    document.getElementById('pbar-fill').classList.remove('shimmer');
    document.getElementById('sv-tot').textContent = tot;
    document.getElementById('sv-acc').textContent = doneCnt;
    document.getElementById('sumrow').style.display = 'flex';
    setStepSub(2,'å®Œæˆ âœ“');
  }
}

// â”€â”€â”€ Log panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleLog() {
  logOpen = !logOpen;
  document.getElementById('logpanel').style.display = logOpen ? 'block' : 'none';
  const arr = document.getElementById('larr');
  arr.className = 'larr' + (logOpen ? ' open' : '');
}

function appendLog(line) {
  const p = document.getElementById('logpanel');
  const cls = /âœ…|å®Œæˆ|done/i.test(line) ? 'ldone'
    : /â–¶/.test(line) ? 'lgrp'
    : /âœ“/.test(line) ? 'lok'
    : /âš |warn|å¤±è´¥/i.test(line) ? 'lwarn'
    : /={3,}/.test(line) ? 'lhead'
    : '';
  const d = document.createElement('div');
  if (cls) d.className = cls;
  d.textContent = line;
  p.appendChild(d);
  p.scrollTop = p.scrollHeight;
}

// â”€â”€â”€ Run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let evtSrc = null;

async function runCrawl() {
  await saveConfig();
  buildGrid();
  setStep(0); setProgress(0,'å‡†å¤‡ä¸­...');
  document.getElementById('progress').className = 'on';
  document.getElementById('sumrow').style.display = 'none';
  document.getElementById('reslink').style.display = 'none';
  document.getElementById('si-fs').style.display = 'none';
  document.getElementById('si-lc').style.display = 'none';
  document.getElementById('logpanel').innerHTML = '';
  document.getElementById('run-btn').disabled = true;

  const output = document.getElementById('run_output').value;
  const noAi   = document.getElementById('run_no_ai').checked;
  const dryRun = document.getElementById('run_dry_run').checked;
  const days   = document.getElementById('search_days').value;

  try {
    const r = await fetch(API+'/api/run',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({output,no_ai:noAi,dry_run:dryRun,days})});
    const res = await r.json();
    if (!res.ok && res.reason !== 'already running') throw new Error(res.error||'å¯åŠ¨å¤±è´¥');
    connectStream();
  } catch(e) {
    appendLog('å¯åŠ¨å¤±è´¥: '+e.message);
    document.getElementById('run-btn').disabled = false;
  }
}

function connectStream() {
  if (evtSrc) evtSrc.close();
  evtSrc = new EventSource(API+'/api/stream');
  evtSrc.onmessage = function(e) {
    const item = JSON.parse(e.data);
    if (item.type === 'ping') return;
    if (item.type === 'log') {
      parseLine(item.text);
      appendLog(item.text);
    } else if (item.type === 'status') {
      document.getElementById('run-btn').disabled = false;
      if (item.status !== 'done') setProgress(100,'è¿è¡Œå‡ºé”™');
      evtSrc.close();
    }
  };
  evtSrc.onerror = function() {
    evtSrc.close();
    document.getElementById('run-btn').disabled = false;
  };
}

// â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConfig() {
  try {
    const r = await fetch(API+'/api/config');
    const cfg = await r.json();
    const ids = ['accounts','search_query_template','invest_accounts','invest_query_template',
                 'extra_accounts','extra_query_template','openrouter_api_key','local_output_dir',
                 'feishu_app_id','feishu_app_secret','feishu_share_openid','search_days','search_num'];
    ids.forEach(id => { const el=document.getElementById(id); if(el&&cfg[id]!==undefined) el.value=cfg[id]; });
    const sel = document.getElementById('openrouter_model');
    const mv = cfg.openrouter_model||'';
    const found = [...sel.options].some(o=>o.value===mv);
    if (found) sel.value = mv;
    else if (mv) { sel.value='custom'; const c=document.getElementById('openrouter_model_custom'); c.style.display='block'; c.value=mv; }
  } catch(e) { console.error(e); }
}

document.getElementById('openrouter_model').addEventListener('change',function(){
  document.getElementById('openrouter_model_custom').style.display = this.value==='custom'?'block':'none';
});

function getModel(){
  const s=document.getElementById('openrouter_model');
  return s.value==='custom'?document.getElementById('openrouter_model_custom').value.trim():s.value;
}

async function saveConfig() {
  const ids=['accounts','search_query_template','invest_accounts','invest_query_template',
             'extra_accounts','extra_query_template','openrouter_api_key','local_output_dir',
             'feishu_app_id','feishu_app_secret','feishu_share_openid','search_days','search_num'];
  const data={openrouter_model:getModel()};
  ids.forEach(id=>{ const el=document.getElementById(id); if(el) data[id]=el.value.trim(); });
  try {
    const r = await fetch(API+'/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const res = await r.json();
    if (res.ok) showToast('âœ“ é…ç½®å·²ä¿å­˜','ok');
    else showToast('ä¿å­˜å¤±è´¥','err');
  } catch(e){ showToast('ä¿å­˜å¤±è´¥','err'); }
}

function toggleEye(id,btn) {
  const el=document.getElementById(id);
  el.type=el.type==='password'?'text':'password';
  btn.textContent=el.type==='password'?'ğŸ‘':'ğŸ™ˆ';
}

let toastT;
function showToast(msg,type){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show '+type;
  clearTimeout(toastT); toastT=setTimeout(()=>t.className=type,2500);
}

loadConfig();
</script>
</body>
</html>
